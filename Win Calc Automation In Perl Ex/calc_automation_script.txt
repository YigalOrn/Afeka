#!/usr/bin/perl

# http://www.piotrkaluski.com/files/winguitest/docs/winguitest.html#SelComboItemText

sub init_workplace {
	use strict;
	use warnings;
	use Win32::GuiTest qw/:ALL/;

	$Win32::GuiTest::debug = 0;
}

sub set_calc_focus {
	my @arr = FindWindowLike(undef, 'Calculator');
	SetFocus($arr[0]);
}

sub open_unit_coversion {
	set_calc_focus();
	SendRawKey(VK_LCONTROL, KEYEVENTF_EXTENDEDKEY);
	SendKeys('u');
	SendRawKey(VK_LCONTROL, KEYEVENTF_EXTENDEDKEY | KEYEVENTF_KEYUP);
}

sub read_input_file {
	open(FILEHANDLER, "<".$ARGV[0]) or die "#ERROR: can't open input file#\n";
	my @inputFileLines = <FILEHANDLER>;
	close(FILEHANDLER) or die "#ERROR: couldn't close input file#\n";
	return @inputFileLines;	
}

sub get_conversion_res {
	my ($title_index, $From_index, $To_index, $val) = @_;
	
	my @windows = FindWindowLike(undef, "Calculator");
	my @children = GetChildWindows($windows[0]);
	my @title_combo = GetComboContents($children[40]);
	
	#-----------------------------------
	# set Title and reset its To and From associated components
	SelComboItemText($children[40], $title_combo[$title_index]);
	SetFocus($children[40]);
	if($title_index<$#title_combo) {
		SendKeys('{DOW}');
		SendKeys('{UP}');
	} else {
		SendKeys('{UP}');
		SendKeys('{DOW}');
	}
	#-----------------------------------
	
	my @unit_combo = GetComboContents($children[43]);
	
	#-----------------------------------
	# set From 
	SelComboItemText($children[43], $unit_combo[$From_index]);
	SetFocus($children[43]);
	if($From_index<$#unit_combo) {
		SendKeys('{DOW}');
		SendKeys('{UP}');
	} else {
		SendKeys('{UP}');
		SendKeys('{DOW}');
	}
	#-----------------------------------
	
	#-----------------------------------
	# set value
	WMSetText($children[42], $val);
	#-----------------------------------
	
	#-----------------------------------
	# set To
	SelComboItemText($children[46], $unit_combo[$To_index]);
	SetFocus($children[46]);
	if($To_index<$#unit_combo) {
		SendKeys('{DOW}');
		SendKeys('{UP}');
	} else {
		SendKeys('{UP}');
		SendKeys('{DOW}');
	}
	#-----------------------------------
	
	#-----------------------------------
	# get conversion result
	return WMGetText($children[45]);
	#-----------------------------------
	
}

init_workplace();
set_calc_focus();
open_unit_coversion();

my @inputFileLines = read_input_file();
open my $outputHandler, '>', $ARGV[1] or die "#ERROR: can't open output file#\n";

for(my $i=0; $i<=$#inputFileLines; $i+=3) {
	my ($description, $wanted_result, $calc_gui_parameters_str) = ($inputFileLines[$i], $inputFileLines[$i+1], $inputFileLines[$i+2]);
	my ($title_index, $From_index, $To_index, $val) = split(/,/, $calc_gui_parameters_str);
	my $calc_coversion_res1 = get_conversion_res($title_index, $From_index, $To_index, $val); # From->To
	my $calc_coversion_res2 = get_conversion_res($title_index, $To_index, $From_index, $calc_coversion_res1); # To->From
	
	my $final_res_str = "From->To: $calc_coversion_res1\nTo->From: $calc_coversion_res2";
	
	# write data to output file
	print $outputHandler "$description\n$wanted_result\n$final_res_str\n";
	print $outputHandler "-----------------------------------------------------\n";
}

close($outputHandler) or die "#ERROR: couldn't close output file#\n";


